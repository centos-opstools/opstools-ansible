---
- name: Enable grafana repository
  copy:
    src: grafana.repo
    dest: '{{yum_repos_d}}/grafana.repo'
  when: manage_repos|default(false)

- name: Install grafana
  package:
    name: '{{ grafana_package_name }}'
    state: present
  when: manage_packages|default(false)

- name: Configure grafana server section
  ini_file:
    dest: '{{ grafana_config_file }}'
    section: server
    option: '{{ item.option }}'
    value: '{{ item.value }}'
    backup: yes
  with_items:
    - option: 'http_port'
      value: '{{ grafana_port }}'
    - option: 'root_url'
      value: 'http://{{ grafana_server_bind}}{{grafana_path}}'
    - option: 'admin_user'
      value: '{{grafana_username}}'
    - option: 'admin_password'
      value: '{{grafana_password}}'
  notify: restart grafana-server

- name: Enable grafana
  service:
    name: '{{ grafana_service_name }}'
    state: started
    enabled: yes
  when: manage_services|default(false)

- name: Insert firewalld rule for grafana
  set_fact:
    firewall_data: >
      {{ firewall_data }} + [
        {
          'port': "{{ grafana_port }}",
          'protocol': 'tcp'
        }
      ]

- name: wait for grafana to be started
  wait_for:
    host: '{{ grafana_server_bind }}'
    port: '{{ grafana_port }}'
    delay: 5
    timeout: 30

- name: create data source for grafana server
  uri:
    method: POST
    header: 'Content-Type: application/json'
    body: "{{ lookup('template', 'data_source.json.j2') |to_json }}"
    body_format: json
    url: https://{{grafana_server_address}}{{grafana_path}}/api/datasources
    username: '{{ grafana_username }}'
    password: '{{ grafana_password }}'
  connection: local
